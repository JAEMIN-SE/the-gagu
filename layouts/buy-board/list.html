{{ define "main" }}

<div class="container" style="max-width:900px;margin:0 auto;padding:28px 16px;">
  <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:14px;">
    <a href="/buy-board/" style="text-decoration:none;color:#111;font-weight:800;">← 목록</a>
    <div style="display:flex;gap:8px;flex-wrap:wrap;">
      {{ with site.Params.kakaoChannel }}<a class="btn" href="{{ . }}" target="_blank" rel="noopener">카카오 상담</a>{{ end }}
      {{ with site.Params.tel }}<a class="btn btn-outline" href="tel:{{ . }}">전화</a>{{ end }}
    </div>
  </div>

  <h1 style="margin:0 0 8px;font-size:32px;font-weight:900;">{{ .Title }}</h1>
  <div style="color:#666;font-size:14px;margin-bottom:18px;">
    작성자: {{ .Params.author | default "익명" }} · {{ .Date.Format "2006-01-02" }}
  </div>

  <div style="border:1px solid #eee;border-radius:14px;padding:18px;line-height:1.8;">
    {{ .Content }}
  </div>

  <style>
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:12px 14px;border:1px solid #111;border-radius:10px;background:#111;color:#fff;text-decoration:none;font-weight:700;}
    .btn-outline{background:#fff;color:#111;}
    @media (max-width: 720px){ h1{font-size:26px !important;} }
  </style>
</div>

<style>
  body { background:#fff; }
  .board-wrap { max-width: 980px; margin: 40px auto; padding: 0 16px; }
  .board-title { font-weight: 800; letter-spacing: -0.5px; }
  .searchbar { max-width: 560px; margin: 18px auto 22px; }
  .table thead th { font-size: 13px; color: #666; }
  .badge-private { background:#f2f3f5; border:1px solid #ddd; color:#333; }
  .img-grid { display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; }
  .img-grid img { width:100%; height:160px; object-fit:cover; border-radius:12px; border:1px solid #eee; }
  @media (max-width: 700px){ .img-grid{ grid-template-columns: repeat(2, 1fr);} }
</style>

<div class="board-wrap">
  <h2 class="text-center board-title">매입문의</h2>

  <div class="searchbar d-flex gap-2">
    <input id="q" class="form-control" placeholder="검색어를 입력해주세요">
    <button id="btnSearch" class="btn btn-dark">검색</button>
    <button id="btnWrite" class="btn btn-outline-dark">글쓰기</button>
  </div>

  <div class="d-flex justify-content-between align-items-center mb-2">
    <div class="small text-muted" id="total">Total 0건 1페이지</div>
  </div>

  <div class="table-responsive">
    <table class="table align-middle">
      <thead>
        <tr>
          <th style="width:80px;">번호</th>
          <th>제목</th>
          <th style="width:120px;">작성자</th>
          <th style="width:90px;">조회</th>
          <th style="width:110px;">날짜</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </div>

  <div class="modal fade" id="modal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">글쓰기</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="modalBody"></div>
      </div>
    </div>
  </div>
</div>

<script>
  const SUPABASE_URL = "https://cogqxioxepqbabczybpk.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_ADAsmOtInEUzu6d3BdyrnQ_jnfAsNz1";
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const rowsEl = document.getElementById("rows");
  const totalEl = document.getElementById("total");
  const qEl = document.getElementById("q");

  const modalEl = document.getElementById("modal");
  const modal = new bootstrap.Modal(modalEl);
  const modalTitle = document.getElementById("modalTitle");
  const modalBody = document.getElementById("modalBody");

  function escapeHtml(s){
    return String(s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }
  function fmtDate(d){
    const dt = new Date(d);
    const mm = String(dt.getMonth()+1).padStart(2,'0');
    const dd = String(dt.getDate()).padStart(2,'0');
    return `${mm}-${dd}`;
  }
  async function sha256(str){
    const enc = new TextEncoder().encode(str);
    const buf = await crypto.subtle.digest("SHA-256", enc);
    return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,"0")).join("");
  }

  async function loadList(){
    const q = (qEl.value || "").trim();
    let query = sb.from("buy_posts")
      .select("id,title,author_name,views,created_at,is_private", { count: "exact" })
      .order("created_at", { ascending: false })
      .limit(30);

    if(q) query = query.ilike("title", `%${q}%`);

    const { data, count, error } = await query;
    if(error){ alert(error.message); return; }

    totalEl.textContent = `Total ${count || 0}건 1페이지`;
    rowsEl.innerHTML = "";

    (data || []).forEach((p, idx) => {
      const no = (count || data.length) - idx;
      const tr = document.createElement("tr");
      const lock = p.is_private ? `<span class="badge badge-private ms-2">비공개</span>` : "";
      tr.innerHTML = `
        <td>${no}</td>
        <td>
          <a href="#" class="text-decoration-none fw-semibold" data-id="${p.id}">
            ${escapeHtml(p.title)}${lock}
          </a>
        </td>
        <td>${escapeHtml(p.author_name || "")}</td>
        <td>${p.views || 0}</td>
        <td>${fmtDate(p.created_at)}</td>
      `;
      rowsEl.appendChild(tr);
    });

    rowsEl.querySelectorAll("a[data-id]").forEach(a => {
      a.addEventListener("click", (e) => {
        e.preventDefault();
        openPasswordPrompt(a.dataset.id);
      });
    });
  }

  function openPasswordPrompt(postId){
    modalTitle.textContent = "비공개 글 확인";
    modalBody.innerHTML = `
      <p class="text-muted small mb-2">비공개 글입니다. 작성 시 설정한 비밀번호를 입력해주세요.</p>
      <div class="d-flex gap-2">
        <input id="pw" type="password" class="form-control" placeholder="비밀번호">
        <button id="ok" class="btn btn-dark">확인</button>
      </div>
      <div id="err" class="text-danger small mt-2" style="display:none;">비밀번호가 올바르지 않습니다.</div>
    `;
    modal.show();

    modalBody.querySelector("#ok").addEventListener("click", async () => {
      const pw = modalBody.querySelector("#pw").value || "";
      const ok = await verifyAndOpen(postId, pw);
      if(!ok) modalBody.querySelector("#err").style.display="block";
    });
  }

  async function verifyAndOpen(postId, pw){
    const { data: post, error } = await sb
      .from("buy_posts")
      .select("*")
      .eq("id", postId)
      .single();

    if(error || !post) return false;

    const hash = await sha256(pw);
    if(hash !== post.password_hash) return false;

    await sb.from("buy_posts").update({ views: (post.views || 0) + 1 }).eq("id", postId);

    const { data: imgs } = await sb.from("buy_images").select("url").eq("post_id", postId).order("created_at");

    modalTitle.textContent = "매입문의 상세";
    modalBody.innerHTML = `
      <div class="mb-2">
        <div class="fw-bold fs-5">${escapeHtml(post.title)}</div>
        <div class="text-muted small">${escapeHtml(post.author_name)} · ${fmtDate(post.created_at)} · 조회 ${ (post.views||0)+1 }</div>
      </div>
      <div class="border rounded-3 p-3 bg-light">
        <div style="white-space:pre-wrap;">${escapeHtml(post.content)}</div>
      </div>

      ${imgs && imgs.length ? `
        <hr class="my-4">
        <div class="fw-semibold mb-2">첨부 사진</div>
        <div class="img-grid">
          ${imgs.map(x => `<a href="${x.url}" target="_blank" rel="noopener noreferrer"><img src="${x.url}" alt="img"></a>`).join("")}
        </div>
      ` : ""}

      <hr class="my-4">
      <div class="d-flex gap-2">
        <button class="btn btn-warning" data-bs-dismiss="modal">닫기</button>
      </div>
    `;
    return true;
  }

  function openWrite(){
    modalTitle.textContent = "매입문의 글쓰기";
    modalBody.innerHTML = `
      <div class="row g-3">
        <div class="col-md-6"><input id="name" class="form-control" placeholder="작성자(필수)"></div>
        <div class="col-md-6"><input id="phone" class="form-control" placeholder="연락처(선택)"></div>
        <div class="col-12"><input id="title" class="form-control" placeholder="제목(필수)"></div>
        <div class="col-12"><textarea id="content" class="form-control" rows="7" placeholder="내용(필수)"></textarea></div>
        <div class="col-md-6"><input id="pw2" type="password" class="form-control" placeholder="비밀번호(필수)"></div>
        <div class="col-md-6"><input id="imgs" type="file" class="form-control" multiple accept="image/*"></div>
        <div class="col-12 d-grid"><button id="submit" class="btn btn-dark btn-lg">등록</button></div>
        <div class="text-muted small">* 사진은 여러 장 업로드 가능 / 비밀번호는 글 확인용</div>
        <div id="werr" class="text-danger small" style="display:none;"></div>
      </div>
    `;
    modal.show();

    modalBody.querySelector("#submit").addEventListener("click", async () => {
      const name = (modalBody.querySelector("#name").value || "").trim();
      const phone = (modalBody.querySelector("#phone").value || "").trim();
      const title = (modalBody.querySelector("#title").value || "").trim();
      const content = (modalBody.querySelector("#content").value || "").trim();
      const pw = (modalBody.querySelector("#pw2").value || "").trim();
      const files = modalBody.querySelector("#imgs").files;

      const err = (msg) => {
        const el = modalBody.querySelector("#werr");
        el.style.display = "block";
        el.textContent = msg;
      };

      if(!name || !title || !content || !pw) return err("작성자/제목/내용/비밀번호는 필수입니다.");

      try{
        const password_hash = await sha256(pw);

        const { data: post, error: e1 } = await sb.from("buy_posts")
          .insert({
            author_name: name,
            phone,
            title,
            content,
            is_private: true,
            password_hash
          })
          .select("id")
          .single();

        if(e1 || !post) throw new Error(e1?.message || "글 등록 실패");

        if(files && files.length){
          for(const f of files){
            const ext = (f.name.split(".").pop() || "jpg").toLowerCase();
            const path = `${post.id}/${crypto.randomUUID()}.${ext}`;

            const up = await sb.storage.from("buy-images").upload(path, f, { upsert:false });
            if(up.error) throw new Error(up.error.message);

            const pub = sb.storage.from("buy-images").getPublicUrl(path);
            const url = pub.data.publicUrl;

            const ins = await sb.from("buy_images").insert({ post_id: post.id, url });
            if(ins.error) throw new Error(ins.error.message);
          }
        }

        modal.hide();
        qEl.value = "";
        await loadList();
        alert("등록 완료! 비밀번호로 글을 확인할 수 있어요.");
      }catch(ex){
        err(ex.message || "오류가 발생했습니다.");
      }
    });
  }

  document.getElementById("btnSearch").addEventListener("click", loadList);
  document.getElementById("btnWrite").addEventListener("click", openWrite);

  loadList();
</script>

{{ end }}
