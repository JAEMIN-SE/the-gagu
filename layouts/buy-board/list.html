{{ define "main" }}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  body{background:#fff;}
  .wrap{max-width:980px;margin:40px auto;padding:0 16px;}
  .title{font-weight:900;letter-spacing:-.5px;}
</style>

<div class="wrap">
  <h2 class="text-center title mb-3">{{ .Title }}</h2>

  <div class="d-flex gap-2 justify-content-center flex-wrap mb-3">
    <input id="q" class="form-control" style="max-width:520px" placeholder="검색어를 입력해주세요">
    <button id="btnSearch" class="btn btn-dark">검색</button>
    <button id="btnWrite" class="btn btn-outline-dark">글쓰기</button>
  </div>

  <div class="small text-muted mb-2" id="total">Total 0건</div>

  <div class="table-responsive">
    <table class="table align-middle">
      <thead>
        <tr>
          <th style="width:80px;">번호</th>
          <th>제목</th>
          <th style="width:120px;">작성자</th>
          <th style="width:110px;">날짜</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </div>
</div>

<div class="modal fade" id="m" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="mt">확인</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="mb"></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  const SUPABASE_URL = "https://cogqxioxepqbabczybpk.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_ADAsmOtInEUzu6d3BdyrnQ_jnfAsNz1";
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const rowsEl = document.getElementById("rows");
  const totalEl = document.getElementById("total");
  const qEl = document.getElementById("q");

  const modal = new bootstrap.Modal(document.getElementById("m"));
  const mt = document.getElementById("mt");
  const mb = document.getElementById("mb");

  function escapeHtml(s){
    return String(s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }
  function fmtDate(d){
    const dt = new Date(d);
    const y = dt.getFullYear();
    const mm = String(dt.getMonth()+1).padStart(2,'0');
    const dd = String(dt.getDate()).padStart(2,'0');
    return `${y}-${mm}-${dd}`;
  }
  async function sha256(str){
    const enc = new TextEncoder().encode(str);
    const buf = await crypto.subtle.digest("SHA-256", enc);
    return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,"0")).join("");
  }

  async function loadList(){
    const q = (qEl.value || "").trim() || null;
    const { data, error } = await sb.rpc("buy_inquiries_list", { q });
    if(error){ alert(error.message); return; }

    totalEl.textContent = `Total ${data?.length || 0}건`;
    rowsEl.innerHTML = "";

    (data || []).forEach((p, idx) => {
      const no = (data.length - idx);
      const badge = p.has_reply ? `<span class="badge text-bg-success ms-2">답변완료</span>` : "";
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${no}</td>
        <td><a href="#" class="fw-semibold text-decoration-none" data-id="${p.id}">${escapeHtml(p.title)}${badge}</a></td>
        <td>${escapeHtml(p.author_name || "익명")}</td>
        <td>${fmtDate(p.created_at)}</td>
      `;
      rowsEl.appendChild(tr);
    });

    rowsEl.querySelectorAll("a[data-id]").forEach(a=>{
      a.addEventListener("click",(e)=>{
        e.preventDefault();
        promptPw(a.dataset.id);
      });
    });
  }

  function promptPw(id){
    mt.textContent = "비밀글 확인";
    mb.innerHTML = `
      <p class="text-muted small mb-2">작성 시 설정한 비밀번호를 입력해주세요.</p>
      <div class="d-flex gap-2">
        <input id="pw" type="password" class="form-control" placeholder="비밀번호">
        <button id="ok" class="btn btn-dark">확인</button>
      </div>
      <div id="err" class="text-danger small mt-2" style="display:none;">비밀번호가 올바르지 않습니다.</div>
    `;
    modal.show();
    mb.querySelector("#ok").addEventListener("click", async ()=>{
      const pw = mb.querySelector("#pw").value || "";
      const h = await sha256(pw);
      const { data, error } = await sb.rpc("buy_inquiries_open", { p_id: id, p_password_hash: h });
      if(error || !data || !data.length){
        mb.querySelector("#err").style.display="block";
        return;
      }
      const post = data[0];
      mt.textContent = "매입문의 상세";
      mb.innerHTML = `
        <div class="mb-2">
          <div class="fw-bold fs-5">${escapeHtml(post.title)}</div>
          <div class="text-muted small">${escapeHtml(post.author_name||"")} · ${fmtDate(post.created_at)} · 조회 ${post.views||0}</div>
        </div>
        <div class="border rounded-3 p-3 bg-light" style="white-space:pre-wrap;">${escapeHtml(post.content)}</div>

        ${post.admin_reply ? `
          <hr class="my-4">
          <div class="fw-semibold mb-2">관리자 답변</div>
          <div class="border rounded-3 p-3">${escapeHtml(post.admin_reply)}</div>
        ` : `
          <hr class="my-4">
          <div class="text-muted">아직 답변이 없습니다. 조금만 기다려주세요.</div>
        `}
      `;
    });
  }

  function openWrite(){
    mt.textContent = "매입문의 글쓰기(비밀)";
    mb.innerHTML = `
      <div class="row g-3">
        <div class="col-md-6"><input id="name" class="form-control" placeholder="작성자(선택)"></div>
        <div class="col-md-6"><input id="phone" class="form-control" placeholder="연락처(선택)"></div>
        <div class="col-12"><input id="title" class="form-control" placeholder="제목(필수)"></div>
        <div class="col-12"><textarea id="content" class="form-control" rows="7" placeholder="내용(필수)"></textarea></div>
        <div class="col-md-6"><input id="pw2" type="password" class="form-control" placeholder="비밀번호(필수)"></div>
        <div class="col-12 d-grid"><button id="submit" class="btn btn-dark btn-lg">등록</button></div>
        <div id="werr" class="text-danger small" style="display:none;"></div>
      </div>
    `;
    modal.show();

    mb.querySelector("#submit").addEventListener("click", async ()=>{
      const name = (mb.querySelector("#name").value || "").trim();
      const phone = (mb.querySelector("#phone").value || "").trim();
      const title = (mb.querySelector("#title").value || "").trim();
      const content = (mb.querySelector("#content").value || "").trim();
      const pw = (mb.querySelector("#pw2").value || "").trim();

      const errEl = mb.querySelector("#werr");
      const err = (msg)=>{ errEl.style.display="block"; errEl.textContent = msg; };

      if(!title || !content || !pw) return err("제목/내용/비밀번호는 필수입니다.");

      try{
        const password_hash = await sha256(pw);
        const { error } = await sb.from("buy_inquiries").insert({
          title, content, author_name: name, phone,
          is_private: true,
          password_hash
        });
        if(error) throw new Error(error.message);

        modal.hide();
        qEl.value = "";
        await loadList();
        alert("등록 완료! 비밀번호로 글을 확인할 수 있어요.");
      }catch(ex){
        err(ex.message || "오류가 발생했습니다.");
      }
    });
  }

  document.getElementById("btnSearch").addEventListener("click", loadList);
  document.getElementById("btnWrite").addEventListener("click", openWrite);

  loadList();
</script>
{{ end }}